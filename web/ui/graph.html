<!DOCTYPE html>
<html>

<style>
    .row {
        margin-top: 15px;
        margin-right: 150px;
        margin-left: 15px;

    }

    .btn {
        border-color: #245580;
        background-color: #245580;
        width: 100px;
        height: 34px;
        color: white;
    }

    .col-lg-10 {
        position: relative;
        min-height: 1px;
        width: 83.33333333%;
    }

    .form-control {
        display: block;
        width: 100%;
        height: 34px;
        padding: 6px 12px;
        font-size: 14px;
        line-height: 1.42857143;
        color: #555;
        background-color: #fff;
        background-image: none;
        border: 1px solid #ccc;
        border-radius: 4px;

    }

    .expression_input {
        width: 100%;
        margin-bottom: 10px;
    }
</style>
<div background-color=#fff;>
    <h2> temsearch</h2>
</div>

<!-- https://developer.mozilla.org/zh-CN/docs/Learn/CSS/Styling_text/Styling_lists -->

<head>
    <meta charset="UTF-8">
    <!-- <link rel="stylesheet" href="/static/graph.css"> -->
    <script type="text/javascript">
        //时间戳转本地时间
        function getLocalTime(ns) {
            const t = new Date(ns * 1000)
            // 日期格式
            format = 'Y-m-d h:i:s'
            let year = t.getFullYear()
            // 由于 getMonth 返回值会比正常月份小 1
            let month = t.getMonth() + 1; if (month < 10) { month = "0" + month }
            let day = t.getDate(); if (day < 10) { day = "0" + day }
            let hours = t.getHours(); if (hours < 10) { hours = "0" + hours }
            let minutes = t.getMinutes(); if (minutes < 10) { minutes = "0" + minutes }
            let seconds = t.getSeconds(); if (seconds < 10) { seconds = "0" + seconds }

            const hash = {
                'y': year,
                'm': month,
                'd': day,
                'h': hours,
                'i': minutes,
                's': seconds
            }
            // 是否补 0
            const isAddZero = (o) => {
                return /M|D|H|I|S/.test(o)
            }
            return format.replace(/\w/g, o => {
                let rt = hash[o.toLocaleLowerCase()]
                return rt > 10 || !isAddZero(o) ? rt : `0${rt}`
            })
        }

        function search() {
            var text = document.getElementById('text-expr').value;
            //console.log(text);
            xmlHttp = new XMLHttpRequest();
            var host = window.location.protocol + "//" + window.location.host;
            xmlHttp.open("get", host + "/search?temql=" + text);
            xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xmlHttp.send(null);

            xmlHttp.onload = function () {
                if (this.status == 200) {
                    //  var data = this.responseText;
                    var str = "";
                    var resBody = document.getElementById("tbody-result")
                    //console.log("this.responseText", this.responseText)
                    var dataJson = JSON.parse(this.responseText);
                    resBody.innerHTML = " ";
                    for (i in dataJson) {
                        var logStr = ""
                        var timeStr = ""
                        for (j in dataJson[i]["logs"]) {
                            logStr += "<tr >" +
                                "<td >" + dataJson[i]["logs"][j]["log"] + "</td >" +
                                "</tr>";
                            timeStr += "<tr >" +
                                "<td >" + getLocalTime(dataJson[i]["logs"][j]["timestamp"]) + "</td >" +
                                "</tr>";
                        }
                        let obj = Object.create(null);
                        var metric = dataJson[i]["metric"]
                        for (let j in dataJson[i]["metric"]) {
                            obj[dataJson[i]["metric"][j]["Name"]] = dataJson[i]["metric"][j]["Value"]
                        }
                        str += "<tr>" +
                            "<td>" + JSON.stringify(obj) + "</td>" +
                            "<td >" + "<table rules=rows cellpadding=\"10\" width=100%>" + timeStr + "</table>" + "</td >" +
                            "<td >" + "<table rules=rows cellpadding=\"10\" width=100%>" + logStr + "</table>" + "</td >" +
                            "</tr>";
                    }
                    resBody.innerHTML = str;
                }
            };

        }
    </script>
</head>
<div id="form-div">

    <div class="row">
        <div class="col-lg-10"></div>
        <textarea id="text-expr" placeholder="输入表达式" name="expr" class="form-control"></textarea>
    </div>

    <div class="row">
        <div class="col-lg-10">
            <input class="btn" type="button" color="white" value="query" name="submit" onclick="search()" />
        </div>
    </div>

</div>

<div>
    <table border="2" bordercolor="gray" style="border-collapse:collapse;">
        <thead>  <tr>  <th>time-series</th>   <th>date</th> <th>logs</th>  </tr>  </thead> 
        <tbody id="tbody-result">
        </tbody>
    </table>
</div>

</html>